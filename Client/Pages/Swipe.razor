@page "/Swipe/{groupId}"
@using SharedLibrary.Models
@using System.Text.Json
@using Client.Connection.GroupManagement
@inject IGroupManager GroupManager
@inject IJSRuntime JsRuntime

@attribute [Authorize(Policy = "SignedIn")]

<AuthorizeView>
    @if (Group is null)
    {
        <PageLoading/>
    }
    else if (!IsGroupMember())
    {
        <p>Skrid pomfrit, det er en lukket fest!</p>
    }
    else
    {
        <!-- component -->
        <div class="p-16">
            <div class="w-full m-auto ">
                <div
                    class="w-4/5 mx-auto grid grid-cols-3 grid-rows-7 grid-flow-row overflow-hidden rounded-xl shadow-md bg-white hover:shadow-xl transition-shadow duration-300 ease-in-out">
                    <div class="col-span-3 row-span-4 p-1 m-1">
                        <a href="#">
                            <img
                                src="https://picsum.photos/640/600/?random"
                                alt="Placeholder"
                                class="rounded-xl object-cover h-96 w-full"/>
                        </a>
                    </div>

                    <div class="col-span-3 row-span-1">
                        <header class="flex items-center justify-between leading-tight p-2">
                            <h3 class="ml-4 text-4xl">
                                @Group.SwipeObject[SwipeCount].Value
                            </h3>
                        </header>
                    </div>

                    <div class="flex items-center justify-between col-span-3 row-span-1 p-2">

                        <button
                            class="w-1/2 py-6 px-4 bg-red-700 hover:bg-red-500 text-white text-2xl rounded-l-xl transition duration-500"
                            @onclick="VoteNo">
                            Nej tak
                        </button>

                        <button
                            class="w-1/2 py-6 px-4 bg-green-700 hover:bg-green-500 text-white text-2xl rounded-r-xl transition duration-500"
                            @onclick="VoteYes">
                            Ja tak!
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</AuthorizeView>

@code {

    [Parameter]
    public string groupId { get; set; }

    private int SwipeCount = 0;
    public Group Group { get; set; }
    private User User { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Group = await GroupManager.GetGroupFromIdAsync(groupId);
        await GetUser();
        await GroupManager.RegisterSwipePage(this);
    }

    public void Match(int id)
    {
        Console.WriteLine($"Tinanana-nananana-nanana giver KAGE! {id}");
    }

    private bool IsGroupMember()
    {
        foreach (User user in Group.Users)
        {
            if (user.Username.Equals(User.Username))
            {
                return true;
            }
        }

        return false;
    }

    private async Task GetUser()
    {
        string userAsJson = await JsRuntime.InvokeAsync<string>("sessionStorage.getItem", "currentUser");
        if (userAsJson is not null)
        {
            User = JsonSerializer.Deserialize<User>(userAsJson);
        }
    }

    private async Task VoteYes()
    {
        await GroupManager.CastVote(groupId, Group.SwipeObject[SwipeCount].Key);
        UpdateCount();
    }

    private async Task VoteNo()
    {
        UpdateCount();
    }

    private void UpdateCount()
    {
        SwipeCount++;
    }

}